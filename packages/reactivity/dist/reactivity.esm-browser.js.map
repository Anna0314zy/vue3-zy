{
  "version": 3,
  "sources": ["../src/effect.ts", "../../shared/src/index.ts", "../src/handler.ts", "../src/reactive.ts"],
  "sourcesContent": ["// TODO \u5168\u5C40\u53D8\u91CF \u8BA9 \u5C5E\u6027 \u8DDF effect \u5173\u8054\u8D77\u6765\nexport let activeEffect = undefined\n\nfunction cleanUpEffect(effect) {\n    // TODO \u6E05\u9664\u4F9D\u8D56 \u6E05\u7406\u4E0A\u4E00\u6B21\u7684\u4F9D\u8D56\u907F\u514D\u6B7B\u5FAA\u73AF \u5148\u5220\u9664 \u540E\u52A0\u4E0A\n   for(let i = 0; i < effect.deps.length; i++) {\n        const dep = effect.deps[i];\n        dep.delete(effect);\n    }\n    effect.deps.length = 0;\n}\n\nexport class ReactiveEffect{\n    // \u9ED8\u8BA4 \u4F1A\u5C06 fn \u6302\u5728\u5230\u7C7B\u7684\u5B9E\u4F8B\u4E0A\n    constructor(private fn, public scheduler?) {\n       this.fn = fn;\n    }\n    parent = undefined;\n    deps = [] //TODO  \u6211\u4F9D\u8D56\u4E86\u54EA\u4E9B\u5C5E\u6027\n    active = true; // \u662F\u5426\u6FC0\u6D3B\n\n    run() {\n        // \u4E0D\u6536\u96C6\u4F9D\u8D56\n      if(!this.active) {\n        return this.fn();\n      }\n      try{\n        this.parent = activeEffect;\n        activeEffect = this;\n        // TODO cleanUpEffect(this); \u5148\u5220\u9664\u6240\u6709\u4F9D\u8D56\n        cleanUpEffect(this);\n        return this.fn();\n      }finally{\n        activeEffect = this.parent;\n        this.parent = undefined\n      }\n    }\n\n    stop() {\n        console.log('stop')\n      // \u867D\u7136\u8FD9\u91CC\u4EAD\u5B50\u4E86\n        if(this.active) {\n            this.active = false;\n            cleanUpEffect(this)\n        }\n    }\n}\n\n\n\n\n//TODO  effect \u8C03\u5EA6\nexport function effect(fn,options:any = {}) {\n\n\n    // \u521B\u5EFA\u4E00\u4E2A\u54CD\u5E94\u5F0F\u7684effect \u5E76\u4E14\u8BA9\u5B83\u6267\u884C\n\n    const _effect = new ReactiveEffect(fn,options.scheduler);\n    _effect.run();\n    // \n    // \u628Arunner \u65B9\u6CD5\u76F4\u63A5\u7ED9\u7528\u6237\n    const runner = _effect.run.bind(_effect);\n    //TODO  \u53EF\u4EE5\u901A\u8FC7runner.effect \u8BBF\u95EE\u5230 effect \u7684\u5B9E\u4F8B\n    runner.effect = _effect;\n    return runner\n}\nconst targetMap = new WeakMap();\nexport function track(target,key) {\n    // \u8BA9\u8FD9\u4E2A\u5BF9\u8C61\u4E0A\u7684\u5C5E\u6027 \u8BB0\u5F55\u5F53\u524D\u7684activeEffect\n\n    console.log('activeEffect',activeEffect)\n\n    if(activeEffect) { // \u8BF4\u660E\u7528\u6237\u5728effect \u4F7F\u7528\u6570\u636E\n\n        let depsMap = targetMap.get(target);\n        // \u5982\u679C\u6CA1\u6709 \u521B\u5EFA\u4E00\u4E2A\u6620\u5C04\u8868\n        if(!depsMap) {\n            targetMap.set(target, (depsMap = new Map()));\n        }\n\n\n        let dep = depsMap.get(key);\n        if(!dep) {\n            depsMap.set(key, (dep = new Set()));\n        }\n\n        let shouldTrack = !dep.has(activeEffect);\n        // \u770B\u4E0B set \u91CC \u662F\u5426\u6709\u8FD9\u4E2Aeffect\n        if(shouldTrack) {\n            dep.add(activeEffect);\n            activeEffect.deps.push(dep);\n        }\n\n\n\n    }\n\n    console.log('targetMap',targetMap)\n    \n}\n\nexport function trigger(target,key,value,oldValue) {\n    // \u901A\u8FC7\u5BF9\u8C61\u4E0A\u7684\u5C5E\u6027 \u8BA9\u8FD9\u4E2A\u5C5E\u6027\u5BF9\u5E94\u7684effect \u91CD\u65B0\u6267\u884C\n\n\n    const depsMap = targetMap.get(target)\n\n    if(!depsMap) {\n        return;\n    }\n    const dep = depsMap.get(key);\n    if(!dep) {\n        return;\n    }\n    const effects = [...dep]\n    effects.forEach((effect:any) => {\n\n        if(effect !== activeEffect) {\n            // TODO  \u907F\u514D\u65E0\u9650\u5FAA\u73AF  \u5982\u679C\u4E0D\u662F\u5F53\u524D\u7684effect \u5C31\u6267\u884C\n            // \u8BA9\u8FD9\u4E2A effect \u6267\u884C\n            // TODO \u8C03\u5EA6\n            if(effect.scheduler) {\n                effect.scheduler();\n            }else {\n                effect.run();\n            }\n        }\n    })\n\n}", "export const isObject = (value) => {\n    return value != null && typeof value === \"object\";\n  };\n  \n  export const isFunction = (value) => {\n    return typeof value === \"function\";\n  };\n  \n  export function isString(value) {\n    return typeof value === \"string\";\n  }\n  \n  export * from \"./shapeFlag\";", "import { ReactiveFlags } from \"./constants\";\nimport { activeEffect,track,trigger } from \"./effect\";\nimport { isObject } from \"@vue/shared\";\nimport { reactive } from \"./reactive\";\n\n\n\nexport const mutableHandler = {\n    get(target, key) {\n        console.log(\"get\", key);\n        console.log(\"activeEffect\",activeEffect)\n        if(key === ReactiveFlags.IS_REACTIVE) {\n            return true;\n        }\n\n    // TODO \u9012\u5F52\u4EE3\u7406  \u53EA\u6709\u53D6\u503C\u7684\u65F6\u5019 \u624D\u53BB \u4EE3\u7406 \u6240\u4EE5\u6027\u80FD\u66F4\u597D\n    if(isObject(target[key])) {\n        return reactive(target[key]);\n    }\n        // \u4F9D\u8D56\u6536\u96C6 \n\n        const res = Reflect.get(target, key);\n\n        track(target, key);\n        return res\n    },\n    set(target, key, value) {\n        let oldValue = target[key];\n        console.log(\"set\", key, value);\n        const r =  Reflect.set(target, key, value);\n\n        if(oldValue !== value) {\n            // TODO \u89E6\u53D1\u66F4\u65B0\n            trigger(target, key,value,oldValue);\n        }\n\n        return r\n    },\n}\n\n\n", "import { isObject } from \"@vue/shared\";\nimport { mutableHandler } from \"./handler\";\nimport { ReactiveFlags } from \"./constants\";\nimport { activeEffect } from \"./effect\";\nconsole.log(isObject({})); // true\nconst reactiveMap = new WeakMap();\n\n\nexport function reactive(target) {\n   \n    return createReactiveObject(target);\n}\n\nfunction createReactiveObject(target) {\n\n    if (!isObject(target)) {\n        return target;\n    }\n\n\n    // \u5982\u679C\u4EE3\u7406\u8FC7\u4E86 \u5C31\u4E0D\u9700\u8981\u518D\u4EE3\u7406\u4E86\n    if(target[ReactiveFlags.IS_REACTIVE]) {\n        return target;\n    }\n    let existingProxy = reactiveMap.get(target);\n    if (existingProxy) {\n        return existingProxy;\n    }\n    const proxy =  new Proxy(target, mutableHandler);\n    // TODO \u505A\u4E2A\u7F13\u5B58  \u5982\u679C\u5DF2\u7ECF\u88AB\u4EE3\u7406\u8FC7 \u5C31\u4E0D\u9700\u8981\u518D\u4EE3\u7406\u4E86\n    reactiveMap.set(target, proxy);\n    return proxy;\n}\n\n\nexport function isReactive(value) {\n    return value[ReactiveFlags.IS_REACTIVE];\n  }"],
  "mappings": "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",
  "names": ["effect"]
}
